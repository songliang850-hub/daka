<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›ºç²¾å…»è‚¾ Â· ç™¾æ—¥ç­‘åŸº</title>
    <style>
        :root {
            --bg-color: #1a1a1a; /* å¢¨é»‘ */
            --paper-color: #e6dfcc; /* å®£çº¸è‰² */
            --text-color: #2c2c2c;
            --accent-red: #8b0000; /* æœ±ç ‚çº¢ - è­¦ç¤º */
            --accent-gold: #b8860b; /* å¸ç‹é»„ - å¼ºè°ƒ */
            --accent-green: #556b2f; /* ç«¹é’ - å…»ç”Ÿ */
        }

        body {
            font-family: "Kaiti", "STKaiti", "KaiTi", "Songti SC", serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .app-container {
            background-color: var(--paper-color);
            width: 100%;
            max-width: 400px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(184, 134, 11, 0.2);
            padding: 20px;
            position: relative;
            border: 2px solid var(--accent-gold);
            overflow: hidden;
        }

        /* é¡¶éƒ¨è£…é¥° */
        .header {
            text-align: center;
            border-bottom: 2px double var(--accent-gold);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 24px;
            margin: 0;
            color: var(--accent-red);
            letter-spacing: 2px;
        }

        .sub-title {
            font-size: 14px;
            color: #555;
            margin-top: 5px;
        }

        /* æ ¸å¿ƒæ•°æ®å±•ç¤º */
        .dashboard-card {
            background: rgba(0,0,0,0.05);
            border: 1px solid var(--accent-gold);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            margin-bottom: 20px;
        }

        .days-count {
            font-size: 48px;
            font-weight: bold;
            color: var(--accent-green);
            line-height: 1;
        }

        .stage-badge {
            display: inline-block;
            background: var(--bg-color);
            color: var(--accent-gold);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 10px;
        }

        /* æ‰“å¡è¡¨å• */
        .check-in-section h3 {
            border-left: 4px solid var(--accent-red);
            padding-left: 10px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        select, input[type="time"], input[type="range"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #fff;
            font-family: inherit;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            margin-bottom: 5px;
        }

        .checkbox-group input {
            margin-right: 10px;
        }

        /* æŒ‰é’® */
        .btn-main {
            width: 100%;
            background-color: var(--accent-green);
            color: white;
            border: none;
            padding: 15px;
            font-size: 18px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            margin-top: 10px;
        }

        .btn-panic {
            width: 100%;
            background-color: var(--accent-red);
            color: white;
            border: none;
            padding: 10px;
            margin-top: 20px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
        }

        /* å¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 999;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--paper-color);
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid var(--accent-red);
            max-width: 300px;
        }

        .modal-text {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .quote-box {
            margin-top: 20px;
            font-style: italic;
            text-align: center;
            font-size: 12px;
            color: #666;
        }

        /* è¿›åº¦æ¡ */
        .progress-bar {
            width: 100%;
            background-color: #ddd;
            height: 10px;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: var(--accent-green);
            width: 0%;
            transition: width 0.5s ease;
        }

        .alert-red { color: var(--accent-red); font-weight: bold; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <h1>å›ºæœ¬åŸ¹å…ƒ</h1>
        <div class="sub-title">è€ä¸­åŒ»äº²æˆ Â· ç™¾æ—¥ç­‘åŸº</div>
    </div>

    <div id="dashboard" class="dashboard-card">
        <div>å·²å›ºå®ˆç²¾æ°”</div>
        <div class="days-count" id="daysCount">0</div>
        <div>å¤©</div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="stage-badge" id="currentStage">ç¬¬ä¸€é˜¶æ®µ Â· ä¸¥ç¦æœŸ</div>
    </div>

    <div id="setupSection" style="display:none;">
        <h3>å¹´è½»äººï¼Œä½•æ—¶ç«‹å¿—å¼€å§‹ï¼Ÿ</h3>
        <div class="form-group">
            <input type="date" id="startDateInput">
        </div>
        <button class="btn-main" onclick="initApp()">ç«‹èª“å¼€å§‹</button>
    </div>

    <div id="checkInSection" class="check-in-section">
        <h3>ä»Šæ—¥æ™šè¯¾ Â· è¯šå®è®°å½•</h3>
        
        <div class="form-group">
            <label>ä»Šæ—¥æˆ’å®ˆæƒ…å†µ <span class="alert-red">*</span></label>
            <select id="abstinenceStatus" onchange="checkWarning()">
                <option value="clean">âœ… å®ˆèº«å¦‚ç‰ (æœªç ´æˆ’)</option>
                <option value="hand_slip">âŒ ç ´æˆ’-æ‰‹æ·« (å¤§å¿Œ)</option>
                <option value="sex">âŒ ç ´æˆ’-æˆ¿äº‹</option>
                <option value="wet_dream">ğŸ’§ é—ç²¾ (éä¸»è§‚ï¼Œä¸æ‰£åˆ†)</option>
            </select>
        </div>

        <div class="form-group">
            <label>æ˜¨å¤œå…¥ç¡æ—¶é—´</label>
            <input type="time" id="sleepTime" value="22:30">
        </div>

        <div class="form-group checkbox-group">
            <label>å…»è‚¾åŠŸè¯¾ï¼š</label>
            <label><input type="checkbox" id="taskRub"> æ‰è…¹36åœˆ</label>
            <label><input type="checkbox" id="taskPoint"> æŒ‰æ‘©ä¸‰ç©´</label>
            <label><input type="checkbox" id="taskStand"> ç«™æ¡©/å¤ªæ</label>
            <label><input type="checkbox" id="taskDiet"> é£Ÿç”¨é»‘è‰²é£Ÿç‰©</label>
        </div>

        <div class="form-group">
            <label>ä»Šæ—¥è…°é…¸ç¨‹åº¦ (1è½»-10é‡)</label>
            <input type="range" min="1" max="10" value="1" id="waistPain" oninput="document.getElementById('painVal').innerText=this.value">
            <div style="text-align:right; font-size:12px;">å½“å‰ï¼š<span id="painVal">1</span></div>
        </div>

        <button class="btn-main" onclick="submitDailyLog()">æäº¤ä»Šæ—¥æ—¥è¯¾</button>
        
        <button class="btn-panic" onclick="showPanicModal()">ğŸš¨ å¿ƒé­”èµ· Â· æ€¥æ•‘æŒ‰é’®</button>
    </div>

    <div class="quote-box" id="dailyQuote">
        â€œç²¾ä¸ºç”Ÿå‘½ä¹‹æœ¬ï¼Œå›ºç²¾å³å›ºå‘½ã€‚â€
    </div>
</div>

<div id="alertModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 style="color:var(--accent-red)">è€ä¸­åŒ»ç—›æ–¥ï¼</h2>
        <div id="modalText" class="modal-text"></div>
        <button class="btn-main" style="background:var(--bg-color); color:var(--text-color); border:1px solid #ccc" onclick="document.getElementById('alertModal').style.display='none'">æ™šè¾ˆçŸ¥é”™äº†</button>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒé€»è¾‘ ---

    const STORAGE_KEY = 'kidney_app_data_v1';
    let appData = {
        startDate: null,
        logs: [],
        lastCheckIn: null
    };

    // è¯­å½•åº“
    const quotes = [
        "å¹´è½»äººï¼Œå¿å¾—ä¸€æ—¶ä¹‹æ¬²ï¼Œæ–¹å¾—ç»ˆèº«ä¹‹å¥ã€‚",
        "ä¸€æ³„å¦‚æ³¨åè¡¥ï¼Œåˆ‡è«å‰åŠŸå°½å¼ƒï¼",
        "å­æ—¶è§‰ï¼Œåƒé‡‘éš¾ä¹°ã€‚å¿«ç¡ï¼",
        "è‚¾æ°”è¶³ï¼Œç™¾ç—…é™¤ï¼›è‚¾æ°”è™šï¼Œç™¾ç—…æ¬ºã€‚",
        "ç°åœ¨å…‹åˆ¶ï¼Œæ˜¯ä¸ºäº†å°†æ¥ä¸åœ¨æ­¤å¤„åæ‚”ã€‚"
    ];

    // åˆå§‹åŒ–
    window.onload = function() {
        loadData();
        renderUI();
        document.getElementById('dailyQuote').innerText = quotes[Math.floor(Math.random() * quotes.length)];
    };

    function loadData() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            appData = JSON.parse(saved);
        }
    }

    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
    }

    function initApp() {
        const dateInput = document.getElementById('startDateInput').value;
        if (!dateInput) return alert("è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸ");
        
        appData.startDate = dateInput;
        saveData();
        renderUI();
    }

    // è®¡ç®—é€»è¾‘
    function getDaysElapsed() {
        if (!appData.startDate) return 0;
        const start = new Date(appData.startDate);
        const now = new Date();
        const diff = now - start;
        return Math.floor(diff / (1000 * 60 * 60 * 24));
    }

    function getStage(days) {
        if (days <= 28) return { name: "ç¬¬ä¸€é˜¶æ®µ Â· ä¸¥ç¦æœŸ (ç¦æ­¢ä¸€åˆ‡)", max: 28, color: "#8b0000" };
        if (days <= 56) return { name: "ç¬¬äºŒé˜¶æ®µ Â· å·©å›ºæœŸ (æ¸…å¿ƒå¯¡æ¬²)", max: 56, color: "#b8860b" };
        return { name: "ç¬¬ä¸‰é˜¶æ®µ Â· æ¢å¤æœŸ (èŠ‚åˆ¶æœ‰åº¦)", max: 90, color: "#556b2f" };
    }

    // æ¸²æŸ“ç•Œé¢
    function renderUI() {
        if (!appData.startDate) {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('checkInSection').style.display = 'none';
            document.getElementById('dashboard').style.display = 'none';
            return;
        }

        document.getElementById('setupSection').style.display = 'none';
        document.getElementById('checkInSection').style.display = 'block';
        document.getElementById('dashboard').style.display = 'block';

        const days = getDaysElapsed();
        const stage = getStage(days);

        document.getElementById('daysCount').innerText = days;
        document.getElementById('currentStage').innerText = stage.name;
        document.getElementById('currentStage').style.color = stage.color;
        
        // è¿›åº¦æ¡
        const percent = Math.min((days / 90) * 100, 100);
        document.getElementById('progressFill').style.width = percent + "%";
    }

    // äº¤äº’é€»è¾‘
    function checkWarning() {
        const val = document.getElementById('abstinenceStatus').value;
        const days = getDaysElapsed();
        
        if ((val === 'hand_slip' || val === 'sex') && days <= 28) {
            triggerModal("ç³Šæ¶‚å•Šï¼ç°åœ¨æ˜¯ç¬¬ä¸€é˜¶æ®µä¸¥ç¦æœŸï¼<br>è¿™ä¸€æ³„ï¼Œä¸‰åæ—¥ä¹‹åŠŸåºŸäºä¸€æ—¦ï¼<br>ä½ è…°é‡Œçš„ç²¾æ°”åœ¨æµæ³ªå•Šï¼");
            // è¿™é‡Œå¯ä»¥åŠ å…¥éœ‡åŠ¨API
            if(navigator.vibrate) navigator.vibrate([500, 200, 500]); 
        } else if (val === 'hand_slip') {
            triggerModal("æ‰‹æ·«ä¹ƒæ˜¯è‡ªæ®‹è¡Œä¸ºï¼<br>å³ä¾¿è¿‡äº†ä¸¥ç¦æœŸï¼Œä¹Ÿå½“å½»åº•æˆ’é™¤ï¼");
        }
    }

    function submitDailyLog() {
        const status = document.getElementById('abstinenceStatus').value;
        const sleep = document.getElementById('sleepTime').value;
        
        // ç®€å•çš„æ—¶é—´æ£€æŸ¥
        const sleepHour = parseInt(sleep.split(':')[0]);
        if (sleepHour >= 23 || sleepHour < 4) {
             triggerModal("ä½ çœ‹ç°åœ¨å‡ ç‚¹äº†ï¼Ÿ<br>23ç‚¹å‰ä¸ç¡ï¼Œå°±æ˜¯åœ¨é€æ”¯ä½ çš„å‘½ï¼<br>æ˜å¤©å¿…é¡»æ—©ç¡ï¼");
        }

        // ä¿å­˜æ—¥å¿— (ç®€åŒ–ç‰ˆï¼Œä»…ä¿å­˜å½“å¤©)
        appData.lastCheckIn = new Date().toISOString();
        // æ­¤å¤„å¯æ‰©å±•ï¼šå°†è¯¦ç»†æ•°æ®pushåˆ°appData.logsæ•°ç»„ä¸­
        
        saveData();
        alert("ä»Šæ—¥æ—¥è¯¾å·²å½•å…¥ã€‚è€å¤«çœ‹ç€ä½ ï¼Œåˆ‡è«æ¾æ‡ˆã€‚");
    }

    function showPanicModal() {
        triggerModal("å¿ƒé­”ä½œç¥Ÿï¼<br>ç«‹åˆ»æ·±å‘¼å¸ï¼<br>ç°åœ¨å»åš20ä¸ªæ·±è¹²ï¼Œæˆ–è€…å»æ´—æŠŠå†·æ°´è„¸ï¼<br>æƒ³æƒ³ä½ è™šå¼±çš„æ ·å­ï¼Œé‚£æ˜¯ä½ æƒ³è¦çš„å—ï¼Ÿï¼");
    }

    function triggerModal(htmlContent) {
        document.getElementById('modalText').innerHTML = htmlContent;
        document.getElementById('alertModal').style.display = 'flex';
    }

</script>

</body>
</html>